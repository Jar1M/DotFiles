(function(f){var e;var h={Information:0,Warning:1,Error:2,PasswordGenerated:10,Share:11};var d=60*15;var b=d*1000;var a;f.load=function(j){return function(){j.apply(f,arguments);e=f.$;setTimeout(function(){f.notification.refreshIcon();f.config.get("notifications.refresh").then(function(k){if(k!=null&&!isNaN(k)&&k>0){a=setInterval(function(){f.notification.refresh()},b=k*1000)}else{a=setInterval(function(){f.notification.refresh()},b=d*1000)}})},0)}}(f.load);var g=f.enable;f.enable=function(){g.apply(f,arguments);f.notification.refreshIcon();f.notification.refresh({callee:"enable"})};var i=f.disable;f.disable=function(){i.apply(f,arguments);f.notification.refreshIcon()};var c=f.onEvent;f.onEvent=function(j,k){if(k!=null&&k.name=="notification-clear"){f.notification.clear()}else{if(k!=null&&k.name=="notification-refresh"){return f.notification.refresh({callee:"notification-refresh",json:k})}else{if(k!=null&&k.name=="notification-read"){f.notification.read().then(function(l){if(e.grep(l,function(o,m){return !o.viewed}).length>0){e.each(l,function(m,o){o.viewed=true});f.notification.write(f.notification.list=l);f.browser.setBadge("")}})}else{return c.apply(f,arguments)}}}};f.notification={list:[],type:h,clear:function(){f.log("Notification clear all");f.notification.write(f.notification.list=[],null);f.browser.setBadge("");if(f.config.user!=null){f.notification.write([],f.config.user.id)}},refresh:function(){return f.config.get("notifications.lastCheck").then(function(j){f.log("Refreshing notifications - Last Check: "+(j!=null?new Date(parseInt(j)):"none"));f.config.set("notifications.lastCheck",new Date().getTime());return e.ajax({url:f.server+"rest/notifications/",data:{datetime:Math.floor((j!=null?j:new Date().getTime())/1000),refresh:b/1000},dataType:"logmeonce-binary"}).then(function(m){var l=m.notifications;if(m.refresh!=null&&!isNaN(m.refresh)&&m.refresh>0){if(a!=null){clearInterval(a)}a=setInterval(function(){f.notification.refresh()},b=m.refresh*1000);f.config.set("notifications.refresh",m.refresh)}if(f.config.user!=null&&f.config.user.id!=m.user){f.log("Logout notification received");f.disable()}var k=[];e(l).each(function(o,p){if(p.time!=null&&!isNaN(p.time)){p.time=p.time*1000}k.push(f.notification.create(p))});return k.length>0?e.when.apply(e,k).then(function(){return e.grep(Array.prototype.slice.call(arguments),function(n){return n!=null})}):[]},function(m,l,k){f.log("Notification refresh error: "+l);return k})})},read:function(j){if(typeof j=="undefined"){if(f.config.user!=null){return e.when(this.read(null),this.read(f.config.user.id)).then(function(l,m){var k=l.concat(m);k.sort(function(o,n){return n.time-o.time});return f.notification.list=k})}else{return this.read(null).then(function(k){return f.notification.list=k})}}else{return f.config.get("notifications"+(j!=null?"."+j:"")).then(function(k){try{return k!=null&&e.isArray(k=JSON.parse(f.tools.decrypt(k,j!=null?""+j:"public")))?k:[]}catch(l){return[]}})}},write:function(k,j){var m=[];var o={};if(j!=null&&!isNaN(j)){o[j]=[]}e(k).each(function(p,q){if(q.user!=null&&!isNaN(q.user)){if(o[q.user]==null){o[q.user]=[]}o[q.user].push(q)}else{m.push(q)}});if(typeof j=="undefined"||j==null){try{f.config.set("notifications",m.length>0?f.tools.encrypt(JSON.stringify(m.splice(0,99)),"public"):null)}catch(n){f.log("Notification write: "+n)}}for(var l in o){if(typeof j=="undefined"||j==l){try{f.config.set("notifications."+l,o[l].length>0?f.tools.encrypt(JSON.stringify(o[l].splice(0,99)),""+l):null)}catch(n){f.log("Notification write: "+n)}}}},compare:function(m,k){if(m.user==k.user&&m.type==k.type&&m.time==k.time){var l=e.extend({},m,{viewed:null});var j=e.extend({},k,{viewed:null});return JSON.stringify(l)==JSON.stringify(j)}return false},create:function(m,k){var l=e.extend({user:null,type:h.Information,time:new Date().getTime(),viewed:false},m);var j=l.user;return this.read(j).then(function(n){if(e.grep(n,function(o){return f.notification.compare(o,l)}).length>0){return null}n.push(l);n.sort(function(p,o){return o.time-p.time});f.notification.write(n,j);f.notification.refreshIcon();return l})},refreshIcon:function(){this.read().then(function(j){var k=e.grep(j,function(l){return !l.viewed}).length;f.browser.setBadge(k>0?""+Math.min(99,k):"")})}}})(logmeonce);